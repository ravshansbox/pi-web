name: Publish

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 25
          registry-url: https://registry.npmjs.org

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Determine release version
        id: version
        run: |
          LAST_TAG=$(git for-each-ref --count=1 --sort=-version:refname --format='%(refname:short)' refs/tags/v*)
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log "${LAST_TAG}..HEAD" --pretty=format:'%s%n%b%n---')
            BASE_VERSION="${LAST_TAG#v}"
          else
            COMMITS=$(git log --pretty=format:'%s%n%b%n---')
            BASE_VERSION=$(node -e "const fs=require('node:fs');process.stdout.write(JSON.parse(fs.readFileSync('package.json','utf8')).version)")
          fi

          if [ -z "$COMMITS" ]; then
            echo "No commits available for release inference"
            exit 1
          fi

          BUMP=patch
          if printf '%s\n' "$COMMITS" | grep -qiE 'BREAKING CHANGE|^[a-z]+(\(.+\))?!:'; then
            BUMP=major
          elif printf '%s\n' "$COMMITS" | grep -qiE '^feat(\(.+\))?:'; then
            BUMP=minor
          fi

          NEXT_VERSION=$(node -e "const [major, minor, patch] = process.argv[1].split('.').map(Number); const bump = process.argv[2]; if ([major, minor, patch].some(Number.isNaN)) { process.exit(1); } const next = bump === 'major' ? [major + 1, 0, 0] : bump === 'minor' ? [major, minor + 1, 0] : [major, minor, patch + 1]; process.stdout.write(next.join('.'));" "$BASE_VERSION" "$BUMP")
          if git tag --list "v$NEXT_VERSION" | grep -q .; then
            echo "Release tag v$NEXT_VERSION already exists"
            exit 1
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "new=$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set package version
        run: npm version "${{ steps.version.outputs.new }}" --no-git-tag-version

      - name: Publish to npm
        run: npm publish --access public
        env:
          NPM_CONFIG_IGNORE_SCRIPTS: true

      - name: Create and push tag
        run: |
          git tag "v${{ steps.version.outputs.new }}"
          git push origin "v${{ steps.version.outputs.new }}"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.new }}" \
            --title "v${{ steps.version.outputs.new }}" \
            --generate-notes
